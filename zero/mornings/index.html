<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Mornings · Zero</title>
    <link rel="preconnect" href="https://esm.sh" crossorigin>
    <link rel="dns-prefetch" href="https://esm.sh">
    <!-- Optional external style (may not be available in all deployments) -->
    <!-- <link rel="stylesheet" href="/zero/apple-style.css"> -->
    <style>
      :root {
        color-scheme: dark;
      }
      body { background: #000; color: #f5f5f7; margin: 0; font-family: ui-sans-serif, -apple-system, system-ui, Segoe UI, Roboto, Ubuntu, "Helvetica Neue", Arial; }
      .layout { display: grid; grid-template-columns: 260px 1fr; min-height: 100vh; }
      .sidebar { border-right: 1px solid rgba(255,255,255,.08); padding: 16px 14px; background: #0a0a0a; }
      .brand { font-weight: 800; letter-spacing: -.02em; font-size: 18px; margin-bottom: 14px; }
      .week-header { display:flex; align-items:center; justify-content:space-between; gap:8px; margin: 10px 0 8px; }
      .nav-btn { background:#1c1c1e; border:1px solid rgba(255,255,255,.08); color:#f5f5f7; border-radius:10px; height:30px; width:30px; cursor:pointer; }
      .week-strip { display:grid; grid-template-columns: repeat(7, 1fr); gap:8px; }
      .day { padding:10px 8px; background:#1c1c1e; border:1px solid rgba(255,255,255,.08); border-radius:12px; text-align:center; cursor:pointer; }
      .day small { display:block; color:#a1a1a6; font-size:11px; }
      .day strong { display:block; margin-top:2px; font-size:14px; }
      .day.active { outline: 2px solid #0a84ff; }
      .day .dots { margin-top:6px; display:flex; justify-content:center; gap:4px; }
      .dot { width:6px; height:6px; border-radius:50%; background:#2c2c2e; }
      .dot.on { background:#0a84ff; }
      .filters { display:flex; gap:6px; margin-top:10px; flex-wrap:wrap; }
      .chip { padding:6px 10px; background:#1c1c1e; border:1px solid rgba(255,255,255,.08); border-radius:999px; font-size:12px; cursor:pointer; }

      .main { padding: 18px 20px; display:grid; gap: 14px; }
      .topbar { display:flex; align-items:center; justify-content:space-between; gap:10px; }
      .date-title { font-size: 24px; font-weight: 800; letter-spacing: -.02em; margin: 0; }
      .tabs { display:flex; gap:16px; border-bottom:1px solid rgba(255,255,255,.08); padding-bottom:8px; }
      .tab { padding:6px 0; color:#a1a1a6; font-weight:600; cursor:pointer; position:relative; }
      .tab.active { color:#f5f5f7; }
      .tab.active::after { content:""; position:absolute; left:0; right:0; bottom:-8px; height:2px; background:#0a84ff; border-radius:2px; }
      .panel { background:#111; border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:16px; }
      .section { display:grid; gap:10px; }
      textarea.input { resize:vertical; min-height:120px; width:100%; padding:12px 14px; border-radius:14px; border:1px solid rgba(255,255,255,.08); background:#1c1c1e; color:#f5f5f7; outline:none; }
      .button { height:38px; padding:0 14px; border-radius:10px; border:none; background:#0a84ff; color:white; font-weight:700; cursor:pointer; }
      .row { display:flex; align-items:center; gap:10px; }
      .two { display:grid; grid-template-columns: 1fr 1fr; gap:16px; }
      @media (max-width: 960px) { .layout { grid-template-columns: 1fr; } .sidebar { position:sticky; top:0; z-index:10; } .two { grid-template-columns: 1fr; } }
      .list { display:grid; gap:10px; }
      .li { padding:12px; border:1px solid rgba(255,255,255,.08); border-radius:12px; background:#1b1b1d; }
      .muted { color:#a1a1a6; font-size:13px; }
      .title { font-weight:700; margin:0 0 6px 0; }
      .pill { padding:3px 8px; border:1px solid rgba(255,255,255,.12); border-radius:999px; font-size:11px; color:#a1a1a6; }
      .hint { font-size:12px; color:#a1a1a6; }
    </style>
    <script type="importmap">
      {
        "imports": {
          "react": "https://esm.sh/react@18.2.0",
          "react-dom/client": "https://esm.sh/react-dom@18.2.0/client"
        }
      }
    </script>
  </head>
  <body>
    <div id="app-root"><div style="padding:24px">Cargando Mornings…</div></div>
    <script type="module">
      (async () => {
        const rootEl = document.getElementById('app-root');
        try {
          const React = await import('react');
          const { createRoot } = await import('react-dom/client');
          const { useMemo, useState, useEffect, useCallback } = React;

          const DAYS = ['Lun','Mar','Mié','Jue','Vie','Sáb','Dom'];
          const TABS = ['Vision', 'Gratitude', 'Intention', 'Tasks', 'Medicine'];

          function todayStr(d = new Date()) {
            const y = d.getFullYear();
            const m = String(d.getMonth()+1).padStart(2,'0');
            const dd = String(d.getDate()).padStart(2,'0');
            return `${y}-${m}-${dd}`;
          }
          function startOfWeek(d = new Date()) {
            const day = (d.getDay() + 6) % 7; // 0 = Mon
            const s = new Date(d);
            s.setDate(d.getDate() - day);
            s.setHours(0,0,0,0);
            return s;
          }
          function addDays(date, n) { const d = new Date(date); d.setDate(d.getDate() + n); return d; }
          function parseXMLSafe(xmlText) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(xmlText, 'application/xml');
            const err = doc.querySelector('parsererror');
            if (err) throw new Error('Invalid XML');
            return doc;
          }
          function extractDayFromXML(doc) {
            const sel = (q) => doc.querySelector(q);
            const getText = (el) => (el ? el.textContent.trim() : '');
            const dayEl = sel('day');
            const date = dayEl?.getAttribute('date') || todayStr();
            const visionEl = sel('vision');
            const gratitudeEls = Array.from(doc.querySelectorAll('gratitude > item'));
            const intentionEls = Array.from(doc.querySelectorAll('intention > item'));
            const taskEls = Array.from(doc.querySelectorAll('tasks > task'));
            const medEl = sel('medicine');
            const titleEl = sel('vision_title');
            const horizon = visionEl?.getAttribute('horizon') || 'daily';
            return {
              date,
              vision: getText(visionEl),
              visionTitle: getText(titleEl),
              gratitude: gratitudeEls.map((e) => ({ text: getText(e), category: e.getAttribute('category') || 'other' })),
              intention: intentionEls.map((e) => ({ text: getText(e), verb: e.getAttribute('verb') || '', timebox: e.getAttribute('timebox') || '' })),
              tasks: taskEls.map((e) => ({ text: getText(e), done: (e.getAttribute('done')||'false') === 'true' })),
              medicine: getText(medEl),
              horizon,
            };
          }
          function inferDots(day) {
            return {
              vis: !!(day.vision && day.vision.trim()),
              gra: (day.gratitude||[]).length > 0,
              int: (day.intention||[]).length > 0,
              tsk: (day.tasks||[]).length > 0,
              med: !!(day.medicine && day.medicine.trim()),
            };
          }
          function buildPrompt(raw) {
            return (
`You are a disciplined extractor. Return STRICT XML with this structure and order. No explanations.
<day date="${todayStr()}">
  <vision horizon="daily"></vision>
  <vision_title></vision_title>
  <gratitude>
    <item category="self"></item>
  </gratitude>
  <intention>
    <item verb="activate" timebox="today"></item>
  </intention>
  <tasks>
    <task done="false"></task>
  </tasks>
  <medicine></medicine>
  <themes>
    <theme name="entrepreneurship" strength="0.5"/>
  </themes>
  <signals>
    <vision_change score="0.0"/>
  </signals>
  <source></source>
</day>
Rules:
- Tags in English exactly as above; include empty tags if missing.
- Keep content in original language (Spanish input → Spanish content).
- Gratitude and Intention as bullets (items). Max 10 items each. Do not invent tasks.
- Extract horizon if present (e.g., "en dos años" → horizon="2y"). Else horizon="daily".
- Ignore small talk/logistics/noise; keep only meaningful content.

Input:
${raw}`
            );
          }
          const systemPrompt = `You structure Morning Routine transcripts into strict XML for UI rendering. Do not add commentary. Always return valid XML.`;
          function weekLabel(weekStart) { const end = addDays(weekStart, 6); const opts = { month: 'short', day: 'numeric' }; return `${weekStart.toLocaleDateString('es-AR', opts)} – ${end.toLocaleDateString('es-AR', opts)}`; }
          function datePretty(dateStr) { const d = new Date(dateStr); return d.toLocaleDateString('es-AR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }); }
          function horizonLabel(h) { if (h === '2y') return 'Horizon: 2 años'; if (h === '1y') return 'Horizon: 1 año'; if (h === 'daily') return 'Horizon: día'; return `Horizon: ${h}`; }
          function sliceText(t, n) { return (t||'').length > n ? t.slice(0, n) + '…' : (t||''); }

          function App() {
            const [weekStart, setWeekStart] = useState(startOfWeek(new Date()));
            const [selectedDate, setSelectedDate] = useState(todayStr());
            const [activeTab, setActiveTab] = useState('Vision');
            const [daysMap, setDaysMap] = useState(() => { try { return JSON.parse(localStorage.getItem('mornings:days')||'{}'); } catch { return {}; } });
            const [rawInput, setRawInput] = useState('');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            const [compare, setCompare] = useState([]);

            const weekDays = useMemo(() => Array.from({ length: 7 }, (_, i) => addDays(weekStart, i)), [weekStart]);
            const selectedDay = daysMap[selectedDate] || null;
            useEffect(() => { try { localStorage.setItem('mornings:days', JSON.stringify(daysMap)); } catch {} }, [daysMap]);
            const shiftWeek = (delta) => setWeekStart((w) => addDays(w, delta*7));

            const handleImport = useCallback(async () => {
              setLoading(true); setError('');
              try {
                const prompt = buildPrompt(rawInput);
                const resp = await fetch('/chat', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ model: 'gpt-5', messages: [ { role: 'system', content: systemPrompt }, { role: 'user', content: prompt } ], temperature: 0.2 }) });
                const data = await resp.json();
                if (!resp.ok || !data.text) throw new Error(data.detail || data.error || 'LLM error');
                const xml = String(data.text || '').trim();
                const doc = parseXMLSafe(xml);
                const dayObj = extractDayFromXML(doc);
                setDaysMap((m) => ({ ...m, [dayObj.date]: dayObj }));
                setSelectedDate(dayObj.date);
                setRawInput('');
              } catch (e) { setError(String(e?.message || e)); } finally { setLoading(false); }
            }, [rawInput]);

            const toggleCompare = (dateStr) => setCompare((prev) => prev.includes(dateStr) ? prev.filter(d => d !== dateStr) : [...prev, dateStr]);
            const compareDays = compare.map(d => ({ date: d, day: daysMap[d] })).filter(x => x.day);

            const renderTabContent = (tab, day) => {
              if (!day) return React.createElement('p', { className: 'muted' }, 'Sin datos para este día.');
              switch (tab) {
                case 'Vision':
                  return React.createElement(React.Fragment, null,
                    day.visionTitle && React.createElement('h3', { className: 'title' }, day.visionTitle),
                    day.vision && React.createElement('p', null, day.vision),
                    day.horizon && React.createElement('div', { className: 'pill' }, horizonLabel(day.horizon))
                  );
                case 'Gratitude':
                  return React.createElement('ul', { className: 'list' }, ...(day.gratitude||[]).map((g, i) => React.createElement('li', { key: i, className: 'li' }, g.text)));
                case 'Intention':
                  return React.createElement('ul', { className: 'list' }, ...(day.intention||[]).map((it, i) => React.createElement('li', { key: i, className: 'li' }, `${(it.verb||'').toUpperCase()} — ${it.text}${it.timebox?` (${it.timebox})`:''}`)));
                case 'Tasks':
                  return React.createElement('ul', { className: 'list' }, ...(day.tasks||[]).map((t, i) => React.createElement('li', { key: i, className: 'li' }, `${t.done ? '✅' : '⬜️'} ${t.text}`)));
                case 'Medicine':
                  return day.medicine ? React.createElement('blockquote', null, `“${day.medicine}”`) : React.createElement('p', { className: 'muted' }, 'Sin medicina.');
                default:
                  return null;
              }
            };

            return (
              React.createElement('div', { className: 'layout' },
                React.createElement('aside', { className: 'sidebar' },
                  React.createElement('div', { className: 'brand' }, 'Mornings'),
                  React.createElement('div', { className: 'week-header' },
                    React.createElement('button', { className: 'nav-btn', onClick: () => shiftWeek(-1) }, '←'),
                    React.createElement('div', null, weekLabel(weekStart)),
                    React.createElement('button', { className: 'nav-btn', onClick: () => shiftWeek(1) }, '→')
                  ),
                  React.createElement('div', { className: 'week-strip' },
                    ...weekDays.map((d, idx) => {
                      const ds = todayStr(d);
                      const entry = daysMap[ds];
                      const dots = entry ? inferDots(entry) : {};
                      return React.createElement('div', { key: ds, className: `day ${selectedDate === ds ? 'active' : ''}`, onClick: () => setSelectedDate(ds), title: ds },
                        React.createElement('small', null, DAYS[idx]),
                        React.createElement('strong', null, String(d.getDate()).padStart(2,'0')),
                        React.createElement('div', { className: 'dots' },
                          React.createElement('div', { className: `dot ${dots.vis ? 'on' : ''}`, title: 'Vision' }),
                          React.createElement('div', { className: `dot ${dots.gra ? 'on' : ''}`, title: 'Gratitude' }),
                          React.createElement('div', { className: `dot ${dots.int ? 'on' : ''}`, title: 'Intention' }),
                          React.createElement('div', { className: `dot ${dots.tsk ? 'on' : ''}`, title: 'Tasks' })
                        ),
                        entry && React.createElement('div', { className: 'hint' }, entry.visionTitle ? entry.visionTitle.slice(0, 26) : '')
                      );
                    })
                  ),
                  React.createElement('div', { className: 'filters' },
                    React.createElement('button', { className: 'chip', onClick: () => setWeekStart(startOfWeek(new Date())) }, 'Hoy'),
                    React.createElement('button', { className: 'chip', onClick: () => setCompare([]) }, 'Clear Compare')
                  )
                ),
                React.createElement('main', { className: 'main' },
                  React.createElement('div', { className: 'topbar' },
                    React.createElement('h2', { className: 'date-title' }, datePretty(selectedDate)),
                    React.createElement('div', { className: 'row' },
                      React.createElement('button', { className: 'chip', onClick: () => toggleCompare(selectedDate) }, compare.includes(selectedDate) ? '✓ Comparing' : 'Compare'),
                      React.createElement('button', { className: 'chip', onClick: () => setActiveTab('Vision') }, 'Focus Vision')
                    )
                  ),
                  React.createElement('div', { className: 'panel' },
                    React.createElement('div', { className: 'tabs' },
                      ...TABS.map(t => React.createElement('div', { key: t, className: `tab ${activeTab === t ? 'active' : ''}`, onClick: () => setActiveTab(t) }, t))
                    ),
                    React.createElement('div', { className: 'section' }, renderTabContent(activeTab, selectedDay))
                  ),
                  React.createElement('div', { className: 'two' },
                    React.createElement('div', { className: 'panel' },
                      React.createElement('h3', { className: 'title' }, 'Importar transcripción'),
                      React.createElement('p', { className: 'muted' }, 'Pega tu morning routine. Se estructurará con AI.'),
                      React.createElement('textarea', { className: 'input', value: rawInput, onChange: (e) => setRawInput(e.target.value), placeholder: 'Pega texto aquí...' }),
                      React.createElement('div', { className: 'row' },
                        React.createElement('button', { className: 'button', onClick: handleImport, disabled: loading || !rawInput.trim() }, loading ? 'Procesando…' : 'Estructurar con AI'),
                        error && React.createElement('span', { className: 'muted' }, error)
                      ),
                      React.createElement('p', { className: 'hint' }, 'Los datos se guardan localmente en tu navegador.')
                    ),
                    React.createElement('div', { className: 'panel' },
                      React.createElement('h3', { className: 'title' }, 'Comparación rápida (Vision)'),
                      compareDays.length === 0 ? React.createElement('p', { className: 'muted' }, 'Selecciona días con “Compare”')
                      : React.createElement('div', { className: 'list' },
                          ...compareDays.map(({ date, day }) => React.createElement('div', { key: date, className: 'li' },
                            React.createElement('div', { className: 'row', style: { justifyContent: 'space-between' } },
                              React.createElement('strong', null, datePretty(date)),
                              day.horizon && React.createElement('span', { className: 'pill' }, horizonLabel(day.horizon))
                            ),
                            day.visionTitle && React.createElement('div', { className: 'muted' }, day.visionTitle),
                            day.vision && React.createElement('div', null, sliceText(day.vision, 320))
                          ))
                        )
                    )
                  )
                )
              )
            );
          }

          createRoot(rootEl).render(React.createElement(App));
        } catch (e) {
          rootEl.innerHTML = `<div class="panel"><div class="error">Error cargando UI: ${e.message}</div></div>`;
          console.error(e);
        }
      })();
    </script>
  </body>
</html>
